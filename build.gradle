/*
This gradle file is just convenient place for me to put a couple of tasks that I
was playing around with.  It's not necessary to build the plugin, just use IDEA
for that (noting to load the project from the ide/idea subdirectory though).
 */
mountDir = System.getProperty("mountDir", "../sbt-changelist-action-mnt")

osxRamdiskName = System.getProperty("osxRamdiskName", "ramdisk")
osxRamdiskDir = System.getProperty("osxRamdiskDir","/Volumes/$osxRamdiskName")
osxRamdiskSize = System.getProperty("osxRamdiskSize", "1024000")

task testBlah << {


  def result = exec{
    commandLine = ["/bin/echo", "wibble"]
    standardOutput = out
  }
  println "result: ${result.inspect()}"
  println "result: ${out.toString()}"
}

task setupMountDir << {
  File mountFile = new File(mountDir)
  if( mountFile.exists() ){
    println "can't mountFile a ramdisk to [$mountFile.absoluteFile], a file of that name already exists"
    return
  }

  File ramdiskFile = new File(osxRamdiskDir)
  if( ramdiskFile.exists() ){
    println "can't create a ramdisk, [$ramdiskFile.absoluteFile] already exists"
  }

  def attachResult = new ByteArrayOutputStream()
  exec(){
    commandLine = [
      "/usr/bin/hdiutil", "attach", "-nomount", "ram://$osxRamdiskSize" ]
    standardOutput = attachResult
  }

  exec(){
    commandLine = [
      "/usr/sbin/diskutil",
      "erasevolume",
      "HFS+",
      osxRamdiskName,
      attachResult.toString() ]
  }

  exec() {
    commandLine = ["/bin/link", "-s", osxRamdiskDir, mountFile.absoluteFile]
  }

}

task cleanMountDir << {
  delete mountDir
}

